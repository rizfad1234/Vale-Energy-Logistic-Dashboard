<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Compliance Energy & Logistic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #00a2ed; font-family: 'Segoe UI', Tahoma, sans-serif; }
        .card-pbi { background: white; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        /* Header Biru Tua */
        .header-pbi { background: #002050; color: white; padding: 12px 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .stat-box { background: #1a427a; color: white; border-radius: 4px; padding: 20px; text-align: center; }
        .table-container::-webkit-scrollbar { height: 8px; width: 6px; }
        .table-container::-webkit-scrollbar-thumb { background: #1a427a; border-radius: 10px; }
    </style>
</head>
<body class="p-4">

    <nav class="header-pbi mb-6 rounded shadow-lg flex justify-between items-center">
        <div class="flex items-center gap-6">
    <div class="flex items-center justify-center w-32 md:w-40">
        <img src="logo-vale.png" alt="Vale Logo" class="h-" 
             alt="Vale Logo" 
             class="h-8 md:h-12 w-auto object-contain brightness-0 invert"> 
             </div>
    <div class="h-10 w-[2px] bg-white/20 hidden md:block"></div>
    <div>
        <h1 class="font-bold uppercase tracking-tight text-lg md:text-xl leading-none text-white">Monitoring Compliance</h1>
        <p class="text-[10px] opacity-70 uppercase tracking-widest mt-1 text-white">Energy & Logistic Department</p>
    </div>
</div>

        <div class="text-right flex flex-col justify-center border-l border-white/20 pl-6">
            <p id="live-time" class="text-2xl font-black text-[#ffc629] font-mono leading-none"></p>
            <p id="live-date" class="text-[10px] uppercase font-bold tracking-widest opacity-80 mt-1"></p>
        </div>
    </nav>

    <div class="max-w-[1800px] mx-auto space-y-6">
        
        <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-4 card-pbi p-6 relative">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <span class="text-xs font-black text-gray-500 uppercase">Compliance Distribution</span>
                    <select id="areaSelector" class="border text-[10px] p-1 rounded bg-gray-50 font-bold outline-none cursor-pointer hover:bg-gray-100"></select>
                </div>
                <div class="h-[300px]"><canvas id="catPieChart"></canvas></div>
                <div class="absolute top-[58%] left-1/2 -translate-x-1/2 -translate-y-1/2 text-center pointer-events-none">
                    <p class="text-[10px] text-gray-400 uppercase font-bold">Total Assets</p>
                    <h2 id="totalCenter" class="text-4xl font-black text-[#1a427a]">0</h2>
                </div>
            </div>

            <div class="col-span-12 lg:col-span-8 card-pbi p-6">
                <p class="text-[10px] font-black text-gray-500 uppercase mb-4 border-b pb-2">Compliance Status Breakdown</p>
                <div class="h-[300px]"><canvas id="catStatusBarChart"></canvas></div>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-4 card-pbi p-6">
                <p class="text-[10px] font-black text-gray-500 uppercase mb-4 border-b pb-2 text-center">Energy vs Logistic Ratio</p>
                <div class="h-[250px]"><canvas id="deptPieChart"></canvas></div>
            </div>

            <div class="col-span-12 lg:col-span-5 card-pbi p-6">
                <p class="text-[10px] font-black text-gray-500 uppercase mb-4 border-b pb-2 text-center">Status by Department</p>
                <div class="h-[250px]"><canvas id="deptStatusBarChart"></canvas></div>
            </div>

            <div class="col-span-12 lg:col-span-3 space-y-4">
                <div class="stat-box shadow-xl border-b-4 border-white/10">
                    <p class="text-[10px] uppercase font-bold opacity-80 mb-1">Total Equipment</p>
                    <h2 id="totalRight" class="text-5xl font-black">0</h2>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="stat-box py-4">
                        <p class="text-[9px] uppercase font-bold opacity-80">Energy</p>
                        <p id="cntEnergy" class="text-2xl font-black">0</p>
                    </div>
                    <div class="stat-box py-4">
                        <p class="text-[9px] uppercase font-bold opacity-80">Logistic</p>
                        <p id="cntLogistic" class="text-2xl font-black">0</p>
                    </div>
                </div>
                <div class="stat-box py-4 bg-[#002050] border-t-4 border-[#ffc629]">
                    <p class="text-[10px] uppercase font-bold opacity-80">Comply Percentage</p>
                    <h2 class="text-4xl font-black text-[#ffc629]">98%</h2>
                </div>
            </div>
        </div>

        <div class="card-pbi overflow-hidden mb-8">
            <div class="bg-gray-100 p-3 text-[10px] font-black uppercase border-b flex justify-between">
                <span>Detailed Equipment List</span>
                <span class="text-[#1a427a]">PT. Vale Indonesia Tbk.</span>
            </div>
            <div class="table-container overflow-x-auto max-h-[400px]">
                <table class="min-w-full text-[11px] text-left border-collapse">
                    <thead class="bg-white sticky top-0 border-b z-10 shadow-sm">
                        <tr>
                            <th class="p-4 border-r font-black text-gray-400">CATEGORY</th>
                            <th class="p-4 border-r font-black text-gray-400">SECTION</th>
                            <th class="p-4 border-r font-black text-gray-400">EQUIPMENT</th>
                            <th class="p-4 font-black text-gray-400">STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="divide-y bg-white"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);
        
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwl68NIDQAuHyOQBmRMc1MdCibl9BJ9dQVNYQyo8klve-32GlwAmiy1jGL6RTma0-h6Tw/exec";
        let masterData = {}, charts = {};

        async function init() {
            try {
                const response = await fetch(SCRIPT_URL);
                masterData = await response.json();
                const sel = document.getElementById('areaSelector');
                
                sel.innerHTML = '<option value="HOME">ALL AREAS (HOME)</option>';
                Object.keys(masterData).forEach(name => {
                    if(name !== "Main Data for Looker Studio") {
                        const opt = document.createElement('option');
                        opt.value = name; opt.innerText = name; sel.appendChild(opt);
                    }
                });

                sel.addEventListener('change', (e) => updateUI(e.target.value));
                updateUI("HOME");
            } catch (err) { console.error("Error:", err); }
        }

        function updateUI(area) {
            let data;
            if (area === "HOME") {
                // HANYA ambil data dari sheet Looker Studio (Target 473)
                data = masterData["Main Data for Looker Studio"];
                if (!data) data = Object.values(masterData).flat();
            } else {
                data = masterData[area];
            }

            if (!data) return;

            document.getElementById('totalCenter').innerText = data.length;
            document.getElementById('totalRight').innerText = data.length;
            document.getElementById('cntEnergy').innerText = data.filter(i => (i.SECTION||"").includes('Energy')).length;
            document.getElementById('cntLogistic').innerText = data.filter(i => (i.SECTION||"").includes('Logistic')).length;

            renderCharts(data);
            renderSection2(data);
            renderTable(data);
        }

        function renderCharts(data) {
    const area = document.getElementById('areaSelector').value;
    
    // Nama kategori utama sesuai referensi
    const cats = ['Annual Inspection', 'Certification', 'Permit', 'Reporting'];
    
    // 1. DOUGHNUT CHART (KIRI) - Distribusi Total per Kategori
    const catCounts = cats.map(c => data.filter(i => (i.CATEGORY || "").includes(c)).length);
    
    const ctxPie = document.getElementById('catPieChart').getContext('2d');
    if (charts.catPie) charts.catPie.destroy();
    charts.catPie = new Chart(ctxPie, {
        type: 'doughnut',
        data: {
            labels: cats,
            datasets: [{ 
                data: catCounts, 
                backgroundColor: ['#3a86ff', '#1a427a', '#fb5607', '#7209b7'],
                hoverOffset: 15
            }]
        },
        options: {
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: { 
                legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } },
                datalabels: { color: '#fff', font: { weight: 'bold', size: 11 } }
            }
        }
    });

    // 2. GROUPED BAR CHART (KANAN) - Status per Kategori (Valid, Attention, Broken)
    const ctxBar = document.getElementById('catStatusBarChart').getContext('2d');
    if (charts.barStatus) charts.barStatus.destroy();
    charts.barStatus = new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: cats,
            datasets: [
                {
                    label: 'Valid',
                    data: cats.map(c => data.filter(i => (i.CATEGORY || "").includes(c) && (i.STATUS_LICENSE || "").trim().toUpperCase() === 'VALID').length),
                    backgroundColor: '#3a86ff',
                    barPercentage: 0.2, // Membuat diagram balok tipis
                    categoryPercentage: 0.8
                },
                {
                    label: 'Attention',
                    data: cats.map(c => data.filter(i => (i.CATEGORY || "").includes(c) && (i.STATUS_LICENSE || "").trim().toUpperCase() === 'ATTENTION').length),
                    backgroundColor: '#fb5607',
                    barPercentage: 0.2, // Membuat diagram balok tipis
                    categoryPercentage: 0.8
                },
                {
                    label: 'Broken',
                    data: cats.map(c => data.filter(i => (i.CATEGORY || "").includes(c) && (i.STATUS_LICENSE || "").trim().toUpperCase() === 'BROKEN').length),
                    backgroundColor: '#1e293b',
                    barPercentage: 0.2, // Membuat diagram balok tipis
                    categoryPercentage: 0.8
                }
            ]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                x: { grid: { display: false } }
            },
            plugins: {
                legend: { position: 'top', labels: { boxWidth: 12, font: { size: 10 } } },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    color: '#1a427a',
                    font: { weight: 'bold', size: 9 },
                    formatter: (value) => value > 0 ? value : '' // Sembunyikan angka jika 0
                }
            }
        }
    });
}

        function renderSection2(data) {
            const depts = ['Energy', 'Logistic'];
            const ctxDPie = document.getElementById('deptPieChart').getContext('2d');
            if (charts.deptPie) charts.deptPie.destroy();
            charts.deptPie = new Chart(ctxDPie, {
                type: 'pie',
                data: {
                    labels: depts,
                    datasets: [{ data: depts.map(d => data.filter(i => (i.SECTION||"").includes(d)).length), backgroundColor: ['#3a86ff', '#002050'] }]
                },
                options: { maintainAspectRatio: false }
            });

            const ctxDBar = document.getElementById('deptStatusBarChart').getContext('2d');
            if (charts.deptBar) charts.deptBar.destroy();
            charts.deptBar = new Chart(ctxDBar, {
                type: 'bar',
                data: {
                    labels: depts,
                    datasets: [
                        { label: 'Valid', data: depts.map(d => data.filter(i => (i.SECTION||"").includes(d) && (i.STATUS_LICENSE||"") === 'VALID').length), backgroundColor: '#3a86ff' },
                        { label: 'Attention', data: depts.map(d => data.filter(i => (i.SECTION||"").includes(d) && (i.STATUS_LICENSE||"") === 'ATTENTION').length), backgroundColor: '#fb5607' }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    barPercentage: 0.15, // Sangat Tipis
                    plugins: { datalabels: { anchor: 'end', align: 'top' } },
                    scales: { x: { grid: { display: false } }, y: { display: false } }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = data.slice(0, 100).map(item => `
                <tr class="hover:bg-blue-50 transition-colors">
                    <td class="p-4 border-r text-gray-400 font-bold">${item.CATEGORY || '-'}</td>
                    <td class="p-4 border-r text-gray-500 font-medium">${item.SECTION || '-'}</td>
                    <td class="p-4 border-r font-black text-[#1a427a]">${item.EQUIPMENT || '-'}</td>
                    <td class="p-4">
                        <span class="px-3 py-1 rounded-full text-[10px] font-black ${(item.STATUS_LICENSE||"") === 'VALID' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'}">
                            ${item.STATUS_LICENSE || '-'}
                        </span>
                    </td>
                </tr>`).join('');
        }

        // Realtime Clock Function
        function updateClock() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            
            document.getElementById('live-time').innerText = now.toLocaleTimeString('id-ID', { hour12: false });
            document.getElementById('live-date').innerText = now.toLocaleDateString('id-ID', options);
        }
        setInterval(updateClock, 1000);
        updateClock();

        init();
    </script>
</body>
</html>